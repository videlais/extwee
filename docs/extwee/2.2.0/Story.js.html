<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Source: Story.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body data-theme="light"><div class="sidebar-container"><div class="sidebar" id="sidebar"><a href="/" class="sidebar-title sidebar-title-anchor">Home</a><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="M0rnSgm7wbvG2mc4KVOxG"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module.exports.html">exports</a></div><div class="sidebar-section-children"><a href="module.exports_module.exports.html">exports</a></div><div class="sidebar-section-children"><a href="module.exports_module.exports.html">exports</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="i-2zkO4b_eQCSR6sBjgja"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#IFID">IFID</a></div><div class="sidebar-section-children"><a href="global.html#IFID">IFID</a></div><div class="sidebar-section-children"><a href="global.html#addPassage">addPassage</a></div><div class="sidebar-section-children"><a href="global.html#author">author</a></div><div class="sidebar-section-children"><a href="global.html#author">author</a></div><div class="sidebar-section-children"><a href="global.html#compile">compile</a></div><div class="sidebar-section-children"><a href="global.html#compile">compile</a></div><div class="sidebar-section-children"><a href="global.html#compile">compile</a></div><div class="sidebar-section-children"><a href="global.html#creator">creator</a></div><div class="sidebar-section-children"><a href="global.html#creator">creator</a></div><div class="sidebar-section-children"><a href="global.html#creatorVersion">creatorVersion</a></div><div class="sidebar-section-children"><a href="global.html#creatorVersion">creatorVersion</a></div><div class="sidebar-section-children"><a href="global.html#description">description</a></div><div class="sidebar-section-children"><a href="global.html#description">description</a></div><div class="sidebar-section-children"><a href="global.html#escapeMetacharacters">escapeMetacharacters</a></div><div class="sidebar-section-children"><a href="global.html#forEachPassage">forEachPassage</a></div><div class="sidebar-section-children"><a href="global.html#format">format</a></div><div class="sidebar-section-children"><a href="global.html#format">format</a></div><div class="sidebar-section-children"><a href="global.html#formatVersion">formatVersion</a></div><div class="sidebar-section-children"><a href="global.html#formatVersion">formatVersion</a></div><div class="sidebar-section-children"><a href="global.html#getPassageByName">getPassageByName</a></div><div class="sidebar-section-children"><a href="global.html#getPassagesByTag">getPassagesByTag</a></div><div class="sidebar-section-children"><a href="global.html#image">image</a></div><div class="sidebar-section-children"><a href="global.html#image">image</a></div><div class="sidebar-section-children"><a href="global.html#license">license</a></div><div class="sidebar-section-children"><a href="global.html#license">license</a></div><div class="sidebar-section-children"><a href="global.html#metadata">metadata</a></div><div class="sidebar-section-children"><a href="global.html#metadata">metadata</a></div><div class="sidebar-section-children"><a href="global.html#metadata">metadata</a></div><div class="sidebar-section-children"><a href="global.html#metadata">metadata</a></div><div class="sidebar-section-children"><a href="global.html#name">name</a></div><div class="sidebar-section-children"><a href="global.html#name">name</a></div><div class="sidebar-section-children"><a href="global.html#name">name</a></div><div class="sidebar-section-children"><a href="global.html#name">name</a></div><div class="sidebar-section-children"><a href="global.html#name">name</a></div><div class="sidebar-section-children"><a href="global.html#name">name</a></div><div class="sidebar-section-children"><a href="global.html#parse">parse</a></div><div class="sidebar-section-children"><a href="global.html#parse">parse</a></div><div class="sidebar-section-children"><a href="global.html#parse">parse</a></div><div class="sidebar-section-children"><a href="global.html#parse">parse</a></div><div class="sidebar-section-children"><a href="global.html#parse">parse</a></div><div class="sidebar-section-children"><a href="global.html#parse">parse</a></div><div class="sidebar-section-children"><a href="global.html#parse">parse</a></div><div class="sidebar-section-children"><a href="global.html#proofing">proofing</a></div><div class="sidebar-section-children"><a href="global.html#proofing">proofing</a></div><div class="sidebar-section-children"><a href="global.html#removePassageByName">removePassageByName</a></div><div class="sidebar-section-children"><a href="global.html#size">size</a></div><div class="sidebar-section-children"><a href="global.html#source">source</a></div><div class="sidebar-section-children"><a href="global.html#source">source</a></div><div class="sidebar-section-children"><a href="global.html#start">start</a></div><div class="sidebar-section-children"><a href="global.html#start">start</a></div><div class="sidebar-section-children"><a href="global.html#tagColors">tagColors</a></div><div class="sidebar-section-children"><a href="global.html#tagColors">tagColors</a></div><div class="sidebar-section-children"><a href="global.html#tags">tags</a></div><div class="sidebar-section-children"><a href="global.html#tags">tags</a></div><div class="sidebar-section-children"><a href="global.html#text">text</a></div><div class="sidebar-section-children"><a href="global.html#text">text</a></div><div class="sidebar-section-children"><a href="global.html#toJSON">toJSON</a></div><div class="sidebar-section-children"><a href="global.html#toJSON">toJSON</a></div><div class="sidebar-section-children"><a href="global.html#toJSON">toJSON</a></div><div class="sidebar-section-children"><a href="global.html#toTwee">toTwee</a></div><div class="sidebar-section-children"><a href="global.html#toTwee">toTwee</a></div><div class="sidebar-section-children"><a href="global.html#toTwine1HTML">toTwine1HTML</a></div><div class="sidebar-section-children"><a href="global.html#toTwine1HTML">toTwine1HTML</a></div><div class="sidebar-section-children"><a href="global.html#toTwine2HTML">toTwine2HTML</a></div><div class="sidebar-section-children"><a href="global.html#toTwine2HTML">toTwine2HTML</a></div><div class="sidebar-section-children"><a href="global.html#url">url</a></div><div class="sidebar-section-children"><a href="global.html#url">url</a></div><div class="sidebar-section-children"><a href="global.html#version">version</a></div><div class="sidebar-section-children"><a href="global.html#version">version</a></div><div class="sidebar-section-children"><a href="global.html#zoom">zoom</a></div><div class="sidebar-section-children"><a href="global.html#zoom">zoom</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#dark-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">Story.js</h1></header><article><pre class="prettyprint source lang-js"><code>import Passage from './Passage.js';
import { v4 as uuidv4 } from 'uuid';

const creatorName = 'extwee';
const version = '2.2.0';

export default class Story {
  /**
   * Internal name of story
   * @private
   */
  #_name = '';

  /**
   * Internal start
   * @private
   */
  #_start = '';

  /**
   * Internal IFID
   * @private
   */
  #_IFID = '';

  /**
   * Internal story format
   * @private
   */
  #_format = '';

  /**
   * Internal version of story format
   */
  #_formatVersion = '';

  /**
   * Internal zoom level
   */
  #_zoom = 0;

  /**
   * Passages
   * @private
   */
  #_passages = [];

  /**
   * Creator
   * @private
   */
  #_creator = '';

  /**
   * CreatorVersion
   * @private
   */
  #_creatorVersion = '';

  /**
   * Metadata
   * @private
   */
  #_metadata = null;

  /**
   * Tag Colors
   * @private
   */
  #_tagColors = {};

  /**
   * Creates a story.
   * @param {string} name - Name of the story.
   */
  constructor (name = '') {
    // Every story has a name.
    this.name = name;
    // Store the creator.
    this.#_creator = creatorName;
    this.#_creatorVersion = version;
    // Set metadata to an object.
    this.#_metadata = {};
  }

  /**
   * Each story has a name
   * @returns {string} Name
   */
  get name () { return this.#_name; }

  /**
   * @param {string} a - Replacement story name
   */
  set name (a) {
    if (typeof a === 'string') {
      this.#_name = a;
    } else {
      throw new Error('Story name must be a string');
    }
  }

  /**
   * Tag Colors object (each property is a tag and its color)
   * @returns {object} tag colors array
   */
  get tagColors () { return this.#_tagColors; }

  /**
   * @param {object} a - Replacement tag colors
   */
  set tagColors (a) {
    if (a instanceof Object) {
      this.#_tagColors = a;
    } else {
      throw new Error('Tag colors must be an object!');
    }
  }

  /**
   * Interactive Fiction ID (IFID) of Story
   * @returns {string} IFID
   */
  get IFID () { return this.#_IFID; }

  /**
   * @param {string} i - Replacement IFID
   */
  set IFID (i) {
    if (typeof i === 'string') {
      this.#_IFID = i;
    } else {
      throw new Error('IFID must be a String!');
    }
  }

  /**
   * Name of start passage.
   * @returns {string} start
   */
  get start () { return this.#_start; }

  /**
   * @param {string} s - Replacement start
   */
  set start (s) {
    if (typeof s === 'string') {
      this.#_start = s;
    } else {
      throw new Error('start (passage name) must be a String!');
    }
  }

  /**
   * Story format version of Story.
   * @returns {string} story format version
   */
  get formatVersion () { return this.#_formatVersion; }

  /**
   * @param {string} f - Replacement format version
   */
  set formatVersion (f) {
    if (typeof f === 'string') {
      this.#_formatVersion = f;
    } else {
      throw new Error('Story format version must be a String!');
    }
  }

  /**
   * Metadata of Story.
   * @returns {object} metadata of story
   */
  get metadata () { return this.#_metadata; }

  /**
   * @param {object} o - Replacement metadata
   */
  set metadata (o) {
    if (typeof o === 'object') {
      this.#_metadata = o;
    } else {
      throw new Error('Story metadata must be Object!');
    }
  }

  /**
   * Story format of Story.
   * @returns {string} format
   */
  get format () { return this.#_format; }

  /**
   * @param {string} f - Replacement format
   */
  set format (f) {
    if (typeof f === 'string') {
      this.#_format = f;
    } else {
      throw new Error('Story format must be a String!');
    }
  }

  /**
   * Program used to create Story.
   * @returns {string} Creator Program
   */
  get creator () { return this.#_creator; }

  /**
   * @param {string} c - Creator Program of Story
   */
  set creator (c) {
    if (typeof c === 'string') {
      this.#_creator = c;
    } else {
      throw new Error('Creator must be String');
    }
  }

  /**
   * Version used to create Story.
   * @returns {string} Version
   */
  get creatorVersion () { return this.#_creatorVersion; }

  /**
   * @param {string} c - Version of creator program
   */
  set creatorVersion (c) {
    if (typeof c === 'string') {
      this.#_creatorVersion = c;
    } else {
      throw new Error('Creator version must be a string!');
    }
  }

  /**
   * Zoom level.
   * @returns {number} Zoom level
   */
  get zoom () { return this.#_zoom; }

  /**
   * @param {number} n - Replacement zoom level
   */
  set zoom (n) {
    if (typeof n === 'number') {
      // Parse float with a fixed length and then force into Number
      this.#_zoom = Number(Number.parseFloat(n).toFixed(2));
    } else {
      throw new Error('Zoom level must be a Number!');
    }
  }

  /**
   * Add a passage to the story.
   * `StoryData` will override story metadata and `StoryTitle` will override story name.
   * @param {Passage} p - Passage to add to Story.
   */
  addPassage (p) {
    // Check if passed argument is a Passage.
    if (!(p instanceof Passage)) {
      // We can only add passages to array.
      throw new Error('Can only add Passages to the story!');
    }

    // Does this passage already exist in the collection?
    // If it does, we ignore it and return.
    if (this.getPassageByName(p.name) !== null) {
      // Warn user
      console.warn('Ignored passage with same name as existing one!');
      //
      return;
    }

    // Parse StoryData.
    if (p.name === 'StoryData') {
      // Try to parse JSON.
      try {
        // Attempt to parse storyData JSON.
        const metadata = JSON.parse(p.text);

        // IFID.
        if (Object.prototype.hasOwnProperty.call(metadata, 'ifid')) {
          this.IFID = metadata.ifid;
        }

        // Format.
        if (Object.prototype.hasOwnProperty.call(metadata, 'format')) {
          this.format = metadata.format;
        }

        // formatVersion.
        if (Object.prototype.hasOwnProperty.call(metadata, 'format-version')) {
          this.formatVersion = metadata['format-version'];
        }

        // Zoom.
        if (Object.prototype.hasOwnProperty.call(metadata, 'zoom')) {
          this.zoom = metadata.zoom;
        }

        // Start.
        if (Object.prototype.hasOwnProperty.call(metadata, 'start')) {
          this.start = metadata.start;
        }

        // Tag colors.
        if (Object.prototype.hasOwnProperty.call(metadata, 'tag-colors')) {
          this.tagColors = metadata['tag-colors'];
        }
      } catch (event) {
        // Ignore errors.
      }

      // Don't add StoryData to passages.
      return;
    }

    // Parse StoryTitle.
    if (p.name === 'StoryTitle') {
      // If there is a StoryTitle passage, we accept the name.
      // Set internal name based on StoryTitle.
      this.name = p.text;
      // Once we override story.name, return.
      return;
    }

    // This is not StoryData or StoryTitle.
    // Push the passage to the array.
    this.#_passages.push(p);
  }

  /**
   * Remove a passage from the story by name.
   * @param {string} name - Passage name to remove
   */
  removePassageByName (name) {
    this.#_passages = this.#_passages.filter(passage => passage.name !== name);
  }

  /**
   * Find passages by tag.
   * @param {string} t - Passage name to search for
   * @returns {Array} Return array of passages
   */
  getPassagesByTag (t) {
    // Look through passages
    return this.#_passages.filter((passage) => {
      // Look through each passage's tags
      return passage.tags.some((tag) => t === tag);
    });
  }

  /**
   * Find passage by name.
   * @param {string} name - Passage name to search for
   * @returns {Passage | null} Return passage or null
   */
  getPassageByName (name) {
    // Look through passages
    const results = this.#_passages.find((passage) => passage.name === name);
    // Return entry or null, if not found
    return results !== undefined ? results : null;
  }

  /**
   * Size (number of passages).
   * @returns {number} Return number of passages
   */
  size () {
    return this.#_passages.length;
  }

  /**
   * forEach-style iterator of passages in Story.
   * @param {Function} callback - Callback function
   */
  forEachPassage (callback) {
    // Check if argument is a function.
    if (typeof callback !== 'function') {
      // Throw error
      throw new Error('Callback must be a function!');
    }

    // Use internal forEach.
    this.#_passages.forEach((element, index) => {
      // Call callback function with element and index.
      callback(element, index);
    });
  }

  /**
   * Export Story as JSON representation.
   * @returns {string} JSON string.
   */
  toJSON () {
    // Create an initial object for later serialization.
    const s = {
      name: this.name,
      tagColors: this.tagColors,
      ifid: this.IFID,
      start: this.start,
      formatVersion: this.formatVersion,
      metadata: this.metadata,
      format: this.format,
      creator: this.creator,
      creatorVersion: this.creatorVersion,
      zoom: this.zoom,
      passages: []
    };

    // For each passage, convert into simple object.
    this.forEachPassage((p) => {
      s.passages.push({
        name: p.name,
        tags: p.tags,
        metadata: p.metadata,
        text: p.text
      });
    });

    // Return stringified Story object.
    return JSON.stringify(s, null, 4);
  }

  /**
   * Return Twee representation.
   *
   * See: Twee 3 Specification
   * (https://github.com/iftechfoundation/twine-specs/blob/master/twee-3-specification.md)
   * @returns {string} Twee String
   */
  toTwee () {
    // Write the StoryData first.
    let outputContents = ':: StoryData\n';

    // Create default object.
    const metadata = {};

    /**
     * ifid: (string) Required. Maps to &lt;tw-storydata ifid>.
     */
    // Is there an IFID?
    if (this.IFID === '') {
      // Generate a new IFID for this work.
      // Twine 2 uses v4 (random) UUIDs, using only capital letters.
      metadata.ifid = uuidv4().toUpperCase();
    } else {
      // Use existing (non-default) value.
      metadata.ifid = this.IFID;
    }

    /**
     * format: (string) Optional. Maps to &lt;tw-storydata format>.
     */
    metadata.format = this.format;

    /**
     * format-version: (string) Optional. Maps to &lt;tw-storydata format-version>.
     */
    metadata['format-version'] = this.formatVersion;

    /**
     * zoom: (decimal) Optional. Maps to &lt;tw-storydata zoom>.
     */
    metadata.zoom = this.zoom;

    /**
     * start: (string) Optional.
     * Maps to &lt;tw-passagedata name> of the node whose pid matches &lt;tw-storydata startnode>.
     */
    metadata.start = this.start;

    /**
     * tag-colors: (object of tag(string):color(string) pairs) Optional.
     * Pairs map to &lt;tw-tag> nodes as &lt;tw-tag name>:&lt;tw-tag color>.
     */
    const numberOfColors = Object.keys(this.tagColors).length;

    // Are there any colors?
    if (numberOfColors > 0) {
      // Add a tag-colors property
      metadata['tag-colors'] = this.tagColors;
    }

    // Write out the story metadata.
    outputContents += `${JSON.stringify(metadata, undefined, 2)}`;

    // Add two newlines.
    outputContents += '\n\n';

    // Write story name as StoryTitle.
    outputContents += ':: StoryTitle\n' + this.name;

    // Add two newlines.
    outputContents += '\n\n';

    // For each passage, append it to the output.
    this.forEachPassage((passage) => {
      outputContents += passage.toTwee();
    });

    // Return the Twee string.
    return outputContents;
  }

  /**
   * Return Twine 2 HTML.
   *
   * See: Twine 2 HTML Output
   * (https://github.com/iftechfoundation/twine-specs/blob/master/twine-2-htmloutput-spec.md)
   * @returns {string} Twine 2 HTML string
   */
  toTwine2HTML () {
    // Prepare HTML content.
    let storyData = `&lt;tw-storydata name="${this.name}"`;
    // Passage Identification (PID) counter.
    // (Twine 2 starts with 1, so we mirror that.)
    let PIDcounter = 1;

    // Does start exist?
    if (this.start === '') {
      // We can't create a Twine 2 HTML file without a starting passage.
      throw new Error('No starting passage!');
    }

    // Try to find starting passage.
    // If it doesn't exist, we throw an error.
    if (this.getPassageByName(this.start) === null) {
      // We can't create a Twine 2 HTML file without a starting passage.
      throw new Error('Starting passage not found');
    }

    // Set initial PID value.
    let startPID = 1;
    // We have to do a bit of nonsense here.
    // Twine 2 HTML cares about PID values.
    this.forEachPassage((p) => {
      // Have we found the starting passage?
      if (p.name === this.start) {
        // If so, set the PID based on index.
        startPID = PIDcounter;
      }
      // Increase and keep looking.
      PIDcounter++;
    });

    // Set starting passage PID.
    storyData += ` startnode="${startPID}"`;

    // Defaults to 'extwee' if missing.
    storyData += ` creator="${this.creator}"`;

    // Default to extwee version.
    storyData += ` creator-version="${this.creatorVersion}"`;

    // Check if IFID exists.
    if (this.IFID !== '') {
      // Write the existing IFID.
      storyData += ` ifid="${this.IFID}"`;
    } else {
      // Generate a new IFID.
      // Twine 2 uses v4 (random) UUIDs, using only capital letters.
      storyData += ` ifid="${uuidv4().toUpperCase()}"`;
    }

    // Write existing or default value.
    storyData += ` zoom="${this.zoom}"`;

    // Write existing or default value.
    storyData += ` format="${this.#_format}"`;

    // Write existing or default value.
    storyData += ` format-version="${this.#_formatVersion}"`;

    // Add the default attributes.
    storyData += ' options hidden>\n';

    // Start the STYLE.
    storyData += '\t&lt;style role="stylesheet" id="twine-user-stylesheet" type="text/twine-css">';

    // Get stylesheet passages.
    const stylesheetPassages = this.getPassagesByTag('stylesheet');

    // Concatenate passages.
    stylesheetPassages.forEach((passage) => {
      // Add text of passages.
      storyData += passage.text;
    });

    // Close the STYLE.
    storyData += '&lt;/style>\n';

    // Start the SCRIPT.
    storyData += '\t&lt;script role="script" id="twine-user-script" type="text/twine-javascript">';

    // Get stylesheet passages.
    const scriptPassages = this.getPassagesByTag('script');

    // Concatenate passages.
    scriptPassages.forEach((passage) => {
      // Add text of passages.
      storyData += passage.text;
    });

    // Close SCRIPT.
    storyData += '&lt;/script>\n';

    // Reset the PID counter.
    PIDcounter = 1;

    // Build the passages HTML.
    this.forEachPassage((passage) => {
      // Append each passage element using the PID counter.
      storyData += passage.toTwine2HTML(PIDcounter);
      // Increase counter inside loop.
      PIDcounter++;
    });

    // Close the HTML element.
    storyData += '&lt;/tw-storydata>';

    // Return HTML contents.
    return storyData;
  }

  /**
   * Return Twine 1 HTML.
   *
   * See: Twine 1 HTML Output
   * (https://github.com/iftechfoundation/twine-specs/blob/master/twine-1-htmloutput-doc.md)
   * @returns {string} Twine 1 HTML string.
   */
  toTwine1HTML () {
    // Begin HTML output.
    let outputContents = '';

    // Process passages (if any).
    this.forEachPassage((p) => {
      // Output HTML output per passage.
      outputContents += `\t${p.toTwine1HTML()}`;
    });

    // Return Twine 1 HTML content.
    return outputContents;
  }
}
</code></pre></article></section></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><a href="/" class="sidebar-title sidebar-title-anchor">Home</a><div class="mobile-nav-links"></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="M0rnSgm7wbvG2mc4KVOxG"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module.exports.html">exports</a></div><div class="sidebar-section-children"><a href="module.exports_module.exports.html">exports</a></div><div class="sidebar-section-children"><a href="module.exports_module.exports.html">exports</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="i-2zkO4b_eQCSR6sBjgja"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#IFID">IFID</a></div><div class="sidebar-section-children"><a href="global.html#IFID">IFID</a></div><div class="sidebar-section-children"><a href="global.html#addPassage">addPassage</a></div><div class="sidebar-section-children"><a href="global.html#author">author</a></div><div class="sidebar-section-children"><a href="global.html#author">author</a></div><div class="sidebar-section-children"><a href="global.html#compile">compile</a></div><div class="sidebar-section-children"><a href="global.html#compile">compile</a></div><div class="sidebar-section-children"><a href="global.html#compile">compile</a></div><div class="sidebar-section-children"><a href="global.html#creator">creator</a></div><div class="sidebar-section-children"><a href="global.html#creator">creator</a></div><div class="sidebar-section-children"><a href="global.html#creatorVersion">creatorVersion</a></div><div class="sidebar-section-children"><a href="global.html#creatorVersion">creatorVersion</a></div><div class="sidebar-section-children"><a href="global.html#description">description</a></div><div class="sidebar-section-children"><a href="global.html#description">description</a></div><div class="sidebar-section-children"><a href="global.html#escapeMetacharacters">escapeMetacharacters</a></div><div class="sidebar-section-children"><a href="global.html#forEachPassage">forEachPassage</a></div><div class="sidebar-section-children"><a href="global.html#format">format</a></div><div class="sidebar-section-children"><a href="global.html#format">format</a></div><div class="sidebar-section-children"><a href="global.html#formatVersion">formatVersion</a></div><div class="sidebar-section-children"><a href="global.html#formatVersion">formatVersion</a></div><div class="sidebar-section-children"><a href="global.html#getPassageByName">getPassageByName</a></div><div class="sidebar-section-children"><a href="global.html#getPassagesByTag">getPassagesByTag</a></div><div class="sidebar-section-children"><a href="global.html#image">image</a></div><div class="sidebar-section-children"><a href="global.html#image">image</a></div><div class="sidebar-section-children"><a href="global.html#license">license</a></div><div class="sidebar-section-children"><a href="global.html#license">license</a></div><div class="sidebar-section-children"><a href="global.html#metadata">metadata</a></div><div class="sidebar-section-children"><a href="global.html#metadata">metadata</a></div><div class="sidebar-section-children"><a href="global.html#metadata">metadata</a></div><div class="sidebar-section-children"><a href="global.html#metadata">metadata</a></div><div class="sidebar-section-children"><a href="global.html#name">name</a></div><div class="sidebar-section-children"><a href="global.html#name">name</a></div><div class="sidebar-section-children"><a href="global.html#name">name</a></div><div class="sidebar-section-children"><a href="global.html#name">name</a></div><div class="sidebar-section-children"><a href="global.html#name">name</a></div><div class="sidebar-section-children"><a href="global.html#name">name</a></div><div class="sidebar-section-children"><a href="global.html#parse">parse</a></div><div class="sidebar-section-children"><a href="global.html#parse">parse</a></div><div class="sidebar-section-children"><a href="global.html#parse">parse</a></div><div class="sidebar-section-children"><a href="global.html#parse">parse</a></div><div class="sidebar-section-children"><a href="global.html#parse">parse</a></div><div class="sidebar-section-children"><a href="global.html#parse">parse</a></div><div class="sidebar-section-children"><a href="global.html#parse">parse</a></div><div class="sidebar-section-children"><a href="global.html#proofing">proofing</a></div><div class="sidebar-section-children"><a href="global.html#proofing">proofing</a></div><div class="sidebar-section-children"><a href="global.html#removePassageByName">removePassageByName</a></div><div class="sidebar-section-children"><a href="global.html#size">size</a></div><div class="sidebar-section-children"><a href="global.html#source">source</a></div><div class="sidebar-section-children"><a href="global.html#source">source</a></div><div class="sidebar-section-children"><a href="global.html#start">start</a></div><div class="sidebar-section-children"><a href="global.html#start">start</a></div><div class="sidebar-section-children"><a href="global.html#tagColors">tagColors</a></div><div class="sidebar-section-children"><a href="global.html#tagColors">tagColors</a></div><div class="sidebar-section-children"><a href="global.html#tags">tags</a></div><div class="sidebar-section-children"><a href="global.html#tags">tags</a></div><div class="sidebar-section-children"><a href="global.html#text">text</a></div><div class="sidebar-section-children"><a href="global.html#text">text</a></div><div class="sidebar-section-children"><a href="global.html#toJSON">toJSON</a></div><div class="sidebar-section-children"><a href="global.html#toJSON">toJSON</a></div><div class="sidebar-section-children"><a href="global.html#toJSON">toJSON</a></div><div class="sidebar-section-children"><a href="global.html#toTwee">toTwee</a></div><div class="sidebar-section-children"><a href="global.html#toTwee">toTwee</a></div><div class="sidebar-section-children"><a href="global.html#toTwine1HTML">toTwine1HTML</a></div><div class="sidebar-section-children"><a href="global.html#toTwine1HTML">toTwine1HTML</a></div><div class="sidebar-section-children"><a href="global.html#toTwine2HTML">toTwine2HTML</a></div><div class="sidebar-section-children"><a href="global.html#toTwine2HTML">toTwine2HTML</a></div><div class="sidebar-section-children"><a href="global.html#url">url</a></div><div class="sidebar-section-children"><a href="global.html#url">url</a></div><div class="sidebar-section-children"><a href="global.html#version">version</a></div><div class="sidebar-section-children"><a href="global.html#version">version</a></div><div class="sidebar-section-children"><a href="global.html#zoom">zoom</a></div><div class="sidebar-section-children"><a href="global.html#zoom">zoom</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#dark-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>